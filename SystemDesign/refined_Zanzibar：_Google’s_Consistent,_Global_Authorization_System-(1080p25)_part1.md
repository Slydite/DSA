# Zanzibar： Google’S Consistent, Global Authorization System (1080P25) - Part 1

![Screenshot at 00:00:00](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-00-00.jpg)

# Google Zanzibar: A Global Authorization System

Google Zanzibar is a distributed system designed to manage and enforce access control across all of Google's services. While the system was initially developed in 2012, its underlying principles and optimizations were documented in a 2019 paper, reflecting years of refinement and challenges overcome.

## Core Functionality: Authorization

At its heart, Zanzibar is an **authorization system**. It determines *who* can access *what* resources and *how* they can interact with them. A familiar example of Zanzibar's operation is the document sharing functionality in Google services like Google Drive and Google Docs.

![Screenshot at 00:00:47](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-00-47.jpg)

When you share a document, you typically assign specific permissions to users or groups. These permissions define a clear hierarchy of access:

| Permission Level | Description                                     | Operations Permitted           |
| :--------------- | :---------------------------------------------- | :----------------------------- |
| **Viewer**       | Can only read or view the content.              | View                           |
| **Editor**       | Can read and modify the content.                | View, Edit                     |
| **Owner**        | Has full control, including deletion.           | View, Edit, Delete             |

![Screenshot at 00:01:47](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-01-47.jpg)

This permission structure is hierarchical:
*   An **Owner** implicitly has all the permissions of an **Editor** and a **Viewer**.
*   An **Editor** implicitly has all the permissions of a **Viewer**.

This means if someone is granted "Owner" access, the system automatically knows they can also "Edit" and "View" the document without needing separate entries for those permissions.

```mermaid
graph TD
    Owner["Owner: All Permissions (View, Edit, Delete)"]
    Editor[Editor: View & Edit Permissions]
    Viewer[Viewer: View Only Permission]

    Owner -- "Includes" --> Editor
    Editor -- "Includes" --> Viewer

    style Owner fill:#f9f,stroke:#333,stroke-width:1px
    style Editor fill:#ccf,stroke:#333,stroke-width:1px
    style Viewer fill:#cfc,stroke:#333,stroke-width:1px
```

## The Scale Challenge: Why Authorization is Hard at Google

One might initially think that managing permissions is straightforward: simply store users, documents, and their associated permissions in a database table. However, for a company like Google, the scale of this problem is immense, presenting several critical challenges:

### 1. Trillions of Records (Access Control Lists - ACLs)

![Screenshot at 00:01:23](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-01-23.jpg)

Google needs to store **trillions of access control lists (ACLs)**. An ACL is essentially a record defining who has what access to a specific resource.
*   **Example ACL Entries:**
    *   `Document_A: Gaurav -> View Access`
    *   `Document_A: Pramudvarma -> Edit Access`
    *   `Document_A: Namur Modi -> Owner Access`

These trillions of records translate into **terabytes of data** that must be stored and quickly retrievable. When a user requests to access a document, the system must query this massive dataset to determine their authorization.

### 2. Millions of Authorization Queries Per Second

The system must handle an astonishing volume of **millions of authorization queries per second**. Each time a user tries to view a Google Doc, open a Google Sheet, or access any other resource, an authorization check occurs. This level of throughput is comparable to systems like Facebook Tau, which also processes millions of graph queries per second. The relationships between users and resources (e.g., "User X is an owner of Document Y") inherently form a vast **graph structure**.

### 3. Billions of Unique Entities (Nodes in the Graph)

The underlying graph representing permissions has an enormous number of distinct nodes:
*   **Billions of Users**: Google's global user base.
*   **Trillions of Documents/Objects**: This includes not just user-created files but also auto-generated content and various internal system objects that require access control.

This results in a system with an astronomical number of objects (users, documents), edges (permissions connecting them), and concurrent queries.

### 4. Stringent Performance Requirements (Low Latency)

Despite the monumental scale, Zanzibar must deliver **tremendous performance** with extremely low latency.
*   When a user requests a document, the total time to fetch it should ideally be under 500 milliseconds (half a second).
*   Within this tight budget, the authorization check itself must complete in **tens of milliseconds**. This means the system needs to provide near real-time authorization decisions for millions of requests concurrently.

### 5. High Reliability

Given its critical role in controlling access to virtually all Google services, Zanzibar must be **exceptionally reliable**. Any failure or inconsistency in the authorization system could have severe consequences, ranging from users being unable to access their data to unauthorized access.

---

### System Reliability: The Five Nines Availability

Zanzibar is a mission-critical system for Google. If it fails, all documents and access to Google services become inaccessible, effectively bringing down Google's core functionality. Due to this extreme criticality, Google demands an incredibly high level of reliability for Zanzibar, targeting **99.999% availability**.

*   **99.999% availability** (often referred to as "five nines") translates to approximately **10 minutes of downtime per year**. This strict requirement underscores the need for robust fault tolerance, redundancy, and rapid recovery mechanisms within the system.

### Query Patterns: Read-Heavy Workload

A key characteristic of authorization systems at Google's scale is the query pattern:
*   **Over 99% of queries are read operations.** Users constantly access documents and resources, triggering authorization checks.
*   **Write operations (setting or changing permissions) are relatively infrequent.** Permissions are typically set when a document is created or shared and then remain stable for long periods.

This read-heavy workload significantly influences the system's design, prioritizing fast reads and efficient caching.

### Representing Permissions: The Graph Model and Relation Tuples

To manage the complex web of users, groups, and documents, Zanzibar models authorization as a **graph**.
*   **Nodes** in this graph represent:
    *   **Users** (e.g., Gaurav, Pramodvarma)
    *   **Documents/Objects** (e.g., UPI Tech Document)
    *   **Groups** (e.g., Engineering Team)
*   **Edges** represent the relationships or permissions between these entities.

![Screenshot at 00:05:11](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-05-11.jpg)
![Screenshot at 00:05:25](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-05-25.jpg)

Instead of simple `(User, Document, Permission)` triplets, Zanzibar uses a more flexible and expressive structure called **Relation Tuples**. These tuples define an edge in the permission graph and follow a specific syntax:

`Object#Relation@Subject`

Let's break down this syntax:

| Component       | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Example                                                                                                                                 |
| :-------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------- |
| `Object`        | The resource or entity being accessed (e.g., a document, a folder, a photo album). This is the "destination" of the permission.                                                                                                                                                                                                                                                                                                                                         | `UPI_TechDoc` (the document itself)                                                                                                     |
| `#`             | A separator indicating the start of the relation.                                                                                                                                                                                                                                                                                                                                                                                                                       |                                                                                                                                         |
| `Relation`      | The type of relationship or permission (e.g., `edit`, `view`, `owner`, `member`). This defines the *kind* of edge.                                                                                                                                                                                                                                                                                                                                                      | `edit` (permission type) `member` (group membership type)                                                                               |
| `@`             | A separator indicating the start of the subject.                                                                                                                                                                                                                                                                                                                                                                                                                        |                                                                                                                                         |
| `Subject`       | The entity (user or group) that has the specified relation to the object. This is the "source" of the permission. The subject can also include a nested relation, allowing for complex group definitions.                                                                                                                                                                                                                                                               | `EngTeam` (the engineering team group) `Gaurav` (an individual user) `org_engineering#member` (all members of the engineering organization) |

![Screenshot at 00:03:48](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-03-48.jpg)

**Examples of Relation Tuples:**

1.  **Direct Permission:**
    `document:UPI_TechDoc#edit@user:Gaurav`
    *   Interpretation: The user "Gaurav" has "edit" access to the "UPI_TechDoc" document.

2.  **Group Permission:**
    `document:UPI_TechDoc#edit@group:EngTeam`
    *   Interpretation: The "EngTeam" group has "edit" access to the "UPI_TechDoc" document. This is powerful because it means anyone who is a member of `EngTeam` automatically inherits `edit` access.

3.  **Group Membership:**
    `group:EngTeam#member@user:Gaurav`
    *   Interpretation: The user "Gaurav" is a "member" of the "EngTeam" group.

These tuples allow for a compact and expressive way to define complex access policies. The system can also utilize **namespaces** (e.g., `document:`, `user:`, `group:`) to prevent ID collisions and organize entities.

#### Resolving Permissions: Graph Traversal

When a user requests access (e.g., "Can Gaurav view UPI_TechDoc?"), Zanzibar performs a graph traversal:
1.  It starts from the target `Object` (e.g., `UPI_TechDoc`).
2.  It looks for all incoming edges (relations) that lead to this object.
3.  If an incoming edge points to an individual user, that user's permission is directly evaluated.
4.  If an incoming edge points to a **group** (e.g., `EngTeam`), the system must **expand** that group. This means recursively checking who are members of that group, and if those members are themselves groups, they are expanded further until individual users are reached. This process forms a tree-like expansion to find all possible paths from the user to the document with the requested permission.

```mermaid
graph TD
    subgraph Authorization Query: "Can Gaurav View UPI_TechDoc?"
        Q[Query: user:Gaurav, document:UPI_TechDoc, view]
    end

    subgraph Zanzibar Graph
        UPI_TechDoc[document:UPI_TechDoc]
        EngTeam[group:EngTeam]
        Gaurav[user:Gaurav]
        Pramod[user:Pramod]
        OrgEng[group:org_engineering]
    end

    UPI_TechDoc -- "edit" --> EngTeam
    EngTeam -- "member" --> Gaurav
    EngTeam -- "member" --> Pramod
    OrgEng -- "member" --> EngTeam

    Q --> CheckPermission[Check if path exists for View access]

    CheckPermission -- "Path 1" --> UPI_TechDoc
    UPI_TechDoc -- "edit" --> EngTeam
    EngTeam -- "member" --> Gaurav

    style Q fill:#f9f,stroke:#333,stroke-width:1px
    style UPI_TechDoc fill:#ccf,stroke:#333,stroke-width:1px
    style EngTeam fill:#cfc,stroke:#333,stroke-width:1px
    style Gaurav fill:#ffc,stroke:#333,stroke-width:1px
    style Pramod fill:#ffc,stroke:#333,stroke-width:1px
    style OrgEng fill:#cfc,stroke:#333,stroke-width:1px
```

### Zanzibar System Architecture

![Screenshot at 00:06:34](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-06-34.jpg)

The overall architecture of Google Zanzibar is designed for massive scale, low latency, and high availability:

1.  **Clients:** These are other Google services (e.g., Google Drive, Google Photos, internal applications) that need to perform authorization checks. They interact with Zanzibar via well-defined APIs.
2.  **APIs:** Zanzibar exposes two primary types of APIs:
    *   **Read API:** For querying authorization status (e.g., "Can user X access document Y?"). This is the most frequently used API.
    *   **Write API:** For creating, updating, or deleting authorization rules (relation tuples).
3.  **Zanzibar System (Internal Servers):** Incoming requests hit a cluster of Zanzibar servers.
    *   **In-Memory Cache:** Due to the "trillions of records" and "terabytes of data," it's impossible to keep all ACLs in memory. Instead, Zanzibar servers maintain an **in-memory cache** of the most recently and frequently accessed ACLs. This is crucial for achieving the low-latency read requirements.
    *   **Durable Storage:** The complete set of authorization data (all relation tuples) is stored in a highly scalable and durable storage system (e.g., Google's Spanner, although the specific storage layer might evolve). When data is not in the in-memory cache, it's fetched from durable storage.
    *   **Consistent Hashing:** Zanzibar employs **consistent hashing** to distribute and locate authorization data across its many internal servers. This ensures that a specific relation tuple is consistently mapped to the same server(s), facilitating efficient lookups and scalability, while also minimizing data movement during server additions or removals.

---

### Zanzibar API Operations

Zanzibar exposes a set of APIs for clients to interact with the authorization system. These APIs support both read (querying permissions) and write (modifying permissions) operations.

#### 1. Read Operations (`read` API)

![Screenshot at 00:08:22](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-08-22.jpg)
![Screenshot at 00:08:41](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-08-41.jpg)

The `read` API is highly flexible and allows for various types of permission queries. Its signature is `read(source*, relation*, destination*, timestamp)`, where parameters marked with an asterisk (`*`) are optional.

| Parameters Provided                     | Query Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| **`Read` API Parameters** | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
    This is because Zanzibar stores the relationships as **relation tuples** in a globally-ordered, consistent storage system (Spanner), allowing it to reconstruct the graph dynamically.

#### Consistent Hashing for Data Distribution

As discussed, due to the massive volume of data, not all ACLs can reside in memory. Zanzibar utilizes **consistent hashing** to distribute its vast dataset across many servers.

*   **How it Works:** Consistent hashing is a technique where both the data items (relation tuples) and the cache servers are mapped onto a conceptual ring. To find a data item, you hash its key to a point on the ring and then move clockwise to find the first server.
*   **Benefits:**
    1.  **Scalability:** Allows adding or removing servers with minimal disruption, as only a small fraction of data needs to be remapped.
    2.  **Efficiency:** Helps locate the correct server holding a specific relation tuple quickly.
    3.  **Caching:** The most frequently used relation tuples are kept in the in-memory cache of these servers, optimizing read performance for hot data.

### Data Consistency: Globally Ordered Timestamps

One of Zanzibar's most critical features is its ability to provide strong data consistency guarantees, primarily through the use of **globally ordered timestamps** provided by Google Spanner.

*   **Causal Consistency:** Zanzibar guarantees **causal consistency**. This means that if a write operation (e.g., granting edit access to a document) happens before a read operation, and the read operation's timestamp is *later* than the write's timestamp, the read *will* reflect that write.
    *   **Scenario 1 (Guaranteed Consistency):**
        1.  **Write:** User A grants edit access to Document D at `Timestamp 100`.
        2.  **Read:** User B queries for edit access to Document D at `Timestamp 101`.
        3.  **Result:** The read will successfully reflect the new edit access.
    *   **Scenario 2 (No Guarantee):**
        1.  **Write:** User A grants edit access to Document D at `Timestamp 100`.
        2.  **Read:** User B queries for edit access to Document D at `Timestamp 99`.
        3.  **Result:** There is **no guarantee** that the read will reflect the new edit access. This is acceptable for many distributed systems where immediate consistency is not always required for historical reads.

*   **Spanner's Role:** Google Spanner, a globally distributed, strongly consistent database, is fundamental to Zanzibar's consistency model. Spanner provides these unique, globally ordered timestamps, which are essential for maintaining the causal consistency guarantee across a massive, distributed system. The client often provides these timestamps (or a recent one) with their read requests to ensure they see data consistent with their last known state.

### Persistent Storage: Google Spanner

![Screenshot at 00:11:06](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-11-06.jpg)

The primary **data store** for Zanzibar is **Google Spanner**. Spanner is a globally distributed, multi-version, synchronously replicated database known for its:
*   **High Consistency:** Offers external consistency (a stronger form of serializability), ensuring that transactions appear to execute as if they occurred at a single point in time globally. This is crucial for maintaining accurate authorization states.
*   **High Availability:** Designed for extreme uptime and fault tolerance, which directly contributes to Zanzibar's "five nines" availability target.
*   **Scalability:** Can scale to petabytes of data and millions of transactions per second across multiple data centers and continents.

#### What is Persisted in Spanner?

Spanner stores several types of data for Zanzibar:

1.  **Relation Tuples:** The core access control lists (ACLs) are stored as relation tuples, defining all user-to-object, group-to-object, and user-to-group relationships. These are the "edges" of the authorization graph.
2.  **Namespace Configurations:** Zanzibar allows for different "namespaces" (e.g., `google_docs`, `google_photos`). Each namespace can have its own configurations and rules, such as:
    *   Maximum number of editors for a document.


---

*   Rules for how relations can be defined.
*   Metadata about the types of objects and relations.

### Change Log for Durability and Recovery

![Screenshot at 00:11:16](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-11-16.jpg)

In addition to the relation tuples and namespace configurations, Zanzibar also stores **append logs** in a **Change Log** within Spanner.

*   **Purpose:** The Change Log records every write operation (create, update, delete) performed on the relation tuples. It acts as a comprehensive, ordered record of all state changes within Zanzibar.
*   **Disaster Recovery:** If any of the internal ACL servers or data stores crash, they can use the Change Log to:
    1.  Spin up a new instance.
    2.  "Replay" the changes from the log to quickly restore their state. This ensures data durability and quick recovery, contributing to Zanzibar's high availability.

### Sharding Strategy for ACL Servers

![Screenshot at 00:13:02](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-13-02.jpg)
![Screenshot at 00:13:14](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-13-14.jpg)

While Spanner handles the ultimate persistence, the internal Zanzibar ACL servers (which act as a sharded, in-memory cache) need an efficient sharding strategy to distribute data and requests. The goal is to optimize for the dominant **read operations**, which are 100x more frequent than writes.

The choice of **shard key** is crucial for efficient data access:

1.  **Initial Thought: (Object ID, Relation Type)**
    *   A natural shard key might seem to be a combination of the `Object ID` and the `Relation Type` (e.g., `document_XYZ` and `edit`).
    *   This would allow requests for a specific permission on a specific document to be routed to a particular shard.

2.  **Refinement: Just Object ID (Primary Shard Key)**
    *   However, common read patterns often involve retrieving *all* permissions for a given object (e.g., "who has access to this document?").
    *   Since there are only a few relation types (viewer, editor, owner), it's more efficient to keep all relations for a single object together on the same shard.
    *   Therefore, the **primary shard key for the ACL servers is simply the `Object ID`**.

*   **Benefit of Object ID Sharding:** When a query like "Get me all users with any access to `Document_A`" comes in, Zanzibar can:
    1.  Use `Document_A` as the shard key to locate the relevant ACL server(s).
    2.  Retrieve all relation tuples associated with `Document_A` from that shard.
    3.  Filter these tuples by relation type (viewer, editor, owner) and then expand any groups to find all relevant users.
    This approach minimizes cross-shard communication for common queries, enhancing performance.

### Background Services: Watcher and Snapshots

![Screenshot at 00:15:00](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-15-00.jpg)

Beyond the core read/write path, Zanzibar leverages its Change Log to power important background services:

1.  **Watch Service:**
    *   **Functionality:** The Watch Service streams events from the Change Log to interested clients (watchers). Clients can subscribe to changes related to specific `Object IDs`.
    *   **Use Cases:**
        *   **Real-time Notifications:** If a user joins a group, and that group is granted access to a document, the Watch Service can notify other services or the user about this new access.
        *   **Automated Actions:** An application might want to automatically onboard users to certain resources as soon as they become members of a specific organizational group.
        *   **Example:** Notifying all members of the "Mumbai" group about a fire alarm in Mumbai.
    *   **Consistency:** The Watch Service operates **eventually consistent**. It pulls data from the Change Log, which means there might be a slight delay between a write operation occurring and the event being streamed to a watcher. This is acceptable as it's not on the critical path for immediate authorization decisions.

2.  **Snapshot Generation (Batch Jobs):**
    *   **Functionality:** Background batch jobs periodically process the Change Log to create **snapshots** of the entire authorization state.
    *   **Purpose:**
        *   **Faster Recovery/Hydration:** Instead of replaying the entire Change Log from the system's inception (e.g., 2012), new or recovering instances can load the latest snapshot (e.g., from September 2024) and then only apply the relatively few changes from the Change Log that occurred *after* that snapshot.
        *   **Historical Analysis:** Snapshots can also be used for auditing or analytical purposes.
    *   **Efficiency:** This significantly reduces the time and resources required to bring new replicas online or recover from major failures, as the "hydration" process starts from a recent, consistent point in time.

---

### Indexing Complex Relations with Leopard

![Screenshot at 00:15:07](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-15-07.jpg)
![Screenshot at 00:15:32](notes_screenshots/refined_Zanzibar：_Google’s_Consistent,_Global_Authorization_System-(1080p25)_screenshots/frame_00-15-32.jpg)

While the core Zanzibar system handles most authorization queries efficiently, certain complex permission scenarios involve **set operations** (e.g., unions, intersections, exclusions of groups). These operations, while logically possible, can be computationally intensive, especially when performed on large user sets or groups. To maintain the strict latency requirements (tens of milliseconds for authorization checks), Zanzibar offloads this complexity to a specialized indexing system called **Leopard**.

*   **Complex Relation Example:** "Share `Document_X` with everyone in `Group_A` but *exclude* those who are also members of `Group_B`."
    *   This requires a set difference operation (`Group_A` - `Group_B`).

*   **Leopard's Role (Pre-computation and Indexing):**
    *   Leopard acts as a background system that **pre-computes** the results of these complex group and user set operations.
    *   It takes **snapshots** of the authorization data (generated by the batch jobs) as its primary input. This allows it to work on a consistent, up-to-date view of the graph.
    *   It also consumes real-time updates from the **Watch Service** to ensure its pre-computed indices are as fresh as possible.
    *   The pre-computed results (e.g., flattened lists of users for a complex group) are then sent back to Zanzibar, essentially acting as an **index** that Zanzibar can query directly instead of performing the complex set operations itself during a live authorization check.
    *   **Analogy:** Think of Leopard as creating a pre-calculated answer sheet for difficult math problems. When Zanzibar encounters one of these problems, it doesn't solve it from scratch; it looks up the answer in Leopard's "answer sheet" (index).

*   **Operational Flow:**
    1.  **Snapshots:** Batch jobs create snapshots of the Spanner data.
    2.  **Leopard Ingestion:** Leopard consumes these snapshots.
    3.  **Real-time Updates:** Leopard also listens to the Watch Service for incremental changes to keep its indices fresh.
    4.  **Pre-computation:** Leopard performs the heavy lifting of resolving complex group memberships and set operations.
    5.  **Index Provisioning:** Leopard provides these pre-computed, optimized user sets or group expansions back to Zanzibar's ACL servers, effectively indexing them.

This separation of concerns allows Zanzibar to maintain its low-latency performance for critical authorization decisions, while Leopard handles the computationally expensive pre-processing in the background.

### Zanzibar's Multi-Level Caching Strategy

The entire Zanzibar system can be viewed as a sophisticated **multi-level caching mechanism** designed to serve authorization requests with optimal latency. The different layers of caching and data access contribute to the overall efficiency:

1.  **Client-Side Caching (Implicit/Not Explicitly Mentioned but Common):** While not detailed, clients (like Google Drive) would likely implement some form of caching for frequently accessed permissions to avoid hitting Zanzibar for every single check.

2.  **Zanzibar ACL Servers (In-Memory Cache):**
    *   This is the primary cache layer within Zanzibar itself.
    *   It stores the most frequently accessed relation tuples in memory, sharded by `Object ID`.
    *   **Impact:** This layer serves the vast majority of requests (potentially **99%** or more), providing sub-millisecond latency for cached data.

3.  **Spanner (Durable Storage):**
    *   This is the ultimate source of truth for all authorization data.
    *   If a request cannot be served from the in-memory cache of the ACL servers, it falls back to Spanner.
    *   **Impact:** While Spanner is highly performant, accessing durable storage is inherently slower than an in-memory cache. This layer handles the remaining **~1%** of requests that are not found in the cache.

The combination of these layers, along with the background pre-computation by Leopard, ensures that Google Zanzibar can meet its demanding requirements for scale, performance, and reliability.

```mermaid
graph TD
    Client["Client Application (e.g., Google Drive)"] --> Request[Authorization Request]

    subgraph Zanzibar System
        direction LR
        ACLServer[ACL Server: In-Memory Cache + Consistent Hashing]
        Spanner["Spanner: Durable Storage (Relation Tuples, Namespace Configs, Change Log)"]

        Request -- "1. Try ACL Server (Cache)" --> ACLServer
        ACLServer -- "Cache Hit (99%+)" --> Response[Authorization Response]
        ACLServer -- "Cache Miss (1%)" --> Spanner
        Spanner -- "2. Fetch from Spanner" --> ACLServer
    end

    subgraph Background Services
        direction LR
        ChangeLog["Change Log (in Spanner)"]
        WatchService[Watch Service]
        BatchJobs[Batch Jobs: Snapshot Generation]
        Leopard[Leopard: Complex Relation Indexing]

        Spanner -- "Append Logs" --> ChangeLog
        ChangeLog -- "Stream Events" --> WatchService
        WatchService -- "Real-time Updates" --> Leopard
        ChangeLog -- "Data Pipeline" --> BatchJobs
        BatchJobs -- "Snapshots" --> Leopard
        Leopard -- "Pre-computed Indices" --> ACLServer
    end

    style Client fill:#f9f,stroke:#333,stroke-width:1px
    style Request fill:#ccf,stroke:#333,stroke-width:1px
    style Response fill:#cfc,stroke:#333,stroke-width:1px
    style ACLServer fill:#ffc,stroke:#333,stroke-width:1px
    style Spanner fill:#cff,stroke:#333,stroke-width:1px
    style ChangeLog fill:#fcf,stroke:#333,stroke-width:1px
    style WatchService fill:#eaf,stroke:#333,stroke-width:1px
    style BatchJobs fill:#afe,stroke:#333,stroke-width:1px
    style Leopard fill:#faa,stroke:#333,stroke-width:1px
```

---

